<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAMusic 音乐中控台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        /* 简单的选项卡样式 */
        .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: bold; }
    </style>
</head>
<body class="bg-[#f3f4f6] min-h-screen p-6 font-sans text-slate-800">

    <!-- 通知容器 -->
    <div id="toast-container" class="fixed top-8 right-8 z-[100] flex flex-col gap-3 w-80 pointer-events-none"></div>

    <!-- 确认弹窗 -->
    <div id="confirm-modal" class="fixed inset-0 z-[90] hidden bg-slate-900/30 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl w-[26rem] p-6 transform transition-all">
            <h3 class="text-lg font-bold text-slate-800 mb-2" id="confirm-title">确认操作</h3>
            <p class="text-slate-500 text-sm mb-6" id="confirm-message">确定吗？</p>
            <div class="flex justify-end gap-3">
                <button id="btn-cancel" class="px-4 py-2 text-sm font-bold text-slate-500 hover:bg-slate-100 rounded-lg">取消</button>
                <button id="btn-confirm" class="px-4 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg">确认</button>
            </div>
        </div>
    </div>

    <!-- 主内容 -->
    <div class="max-w-7xl mx-auto space-y-6">

        <!-- 顶部状态栏 (保持原有设计，省略细节以聚焦变更) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
            <!-- 状态卡片1 -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 h-32 flex flex-col justify-between">
                <div class="flex justify-between">
                    <span class="text-xs font-bold text-slate-400 uppercase">播放模式</span>
                    <i class="fas fa-music text-indigo-400"></i>
                </div>
                <div id="play-mode-display" class="text-lg font-black text-slate-700">单曲搜索</div>
            </div>
            <!-- 状态卡片2 -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 h-32 flex flex-col justify-between">
                <div class="flex justify-between">
                    <span class="text-xs font-bold text-slate-400 uppercase">最后响应</span>
                    <i class="fas fa-clock text-blue-400"></i>
                </div>
                <p id="last-heartbeat" class="text-xl font-black text-slate-700">--:--:--</p>
            </div>
            <!-- 状态卡片3 -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 h-32 flex flex-col justify-between">
                <div class="flex justify-between">
                    <span class="text-xs font-bold text-slate-400 uppercase">累计播放</span>
                    <i class="fas fa-chart-line text-emerald-400"></i>
                </div>
                <p id="success-count" class="text-2xl font-black text-slate-700">0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- 左侧控制区 -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- 1. 手动搜索 -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-sm font-bold text-slate-800 mb-4 flex items-center">
                        <span class="w-1 h-4 bg-blue-500 rounded-full mr-2.5"></span>搜索播放 / 播放歌单
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="song-input" placeholder="输入歌名 或 歌单名" 
                            class="flex-1 px-4 py-2 text-sm bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500">
                        <button onclick="manualPlay()" id="play-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded-xl shadow-md transition">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                    <!-- 音源选择 (省略，保持原有即可) -->
                </div>

                <!-- 2. 播放控制 (需求1：仅保留三个按钮) -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-sm font-bold text-slate-800 mb-4 flex items-center">
                        <span class="w-1 h-4 bg-indigo-500 rounded-full mr-2.5"></span>播放控制
                    </h2>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="controlMedia('previous')" class="bg-slate-50 hover:bg-indigo-50 border border-slate-200 py-4 rounded-xl transition group">
                            <i class="fas fa-step-backward text-slate-500 group-hover:text-indigo-600 text-lg"></i>
                        </button>
                        <button onclick="controlMedia('play_pause')" class="bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 py-4 rounded-xl transition group">
                            <i class="fas fa-pause text-indigo-600 text-xl"></i>
                        </button>
                        <button onclick="controlMedia('next')" class="bg-slate-50 hover:bg-indigo-50 border border-slate-200 py-4 rounded-xl transition group">
                            <i class="fas fa-step-forward text-slate-500 group-hover:text-indigo-600 text-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- 3. 歌单管理 (需求3) -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-[400px] flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-bold text-slate-800 flex items-center">
                            <span class="w-1 h-4 bg-emerald-500 rounded-full mr-2.5"></span>我的歌单
                        </h2>
                        <button onclick="createPlaylistPrompt()" class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded hover:bg-emerald-200 transition">
                            <i class="fas fa-plus mr-1"></i>新建
                        </button>
                    </div>
                    
                    <!-- 歌单列表 -->
                    <div id="playlist-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-1">
                        <!-- JS填充 -->
                        <p class="text-xs text-slate-400 text-center mt-10">加载中...</p>
                    </div>
                </div>
            </div>

            <!-- 右侧日志与歌单详情 -->
            <div class="lg:col-span-8 flex flex-col gap-6">
                
                <!-- 歌单详情编辑区 (默认隐藏，点击歌单时显示) -->
                <div id="playlist-detail-panel" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hidden">
                    <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                        <div>
                            <h3 id="current-playlist-title" class="text-lg font-bold text-slate-800">歌单详情</h3>
                            <p class="text-xs text-slate-400">语音触发词：帮我搜 <span id="trigger-word" class="text-blue-500"></span></p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="renameCurrentPlaylist()" class="text-xs bg-slate-100 text-slate-600 px-3 py-1.5 rounded hover:bg-slate-200">重命名</button>
                            <button onclick="deleteCurrentPlaylist()" class="text-xs bg-rose-50 text-rose-600 px-3 py-1.5 rounded hover:bg-rose-100">删除歌单</button>
                            <button onclick="closePlaylistDetail()" class="text-xs text-slate-400 px-2 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button>
                        </div>
                    </div>

                    <!-- 添加歌曲表单 -->
                    <div class="flex gap-2 mb-4">
                        <input id="new-song-name" type="text" placeholder="歌曲名称" class="w-1/3 px-3 py-2 text-xs bg-slate-50 border rounded-lg">
                        <input id="new-song-url" type="text" placeholder="播放链接 (URL)" class="flex-1 px-3 py-2 text-xs bg-slate-50 border rounded-lg">
                        <button onclick="addSongToPlaylist()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-emerald-700">添加</button>
                    </div>

                    <!-- 歌曲列表 -->
                    <div id="playlist-songs-list" class="max-h-60 overflow-y-auto custom-scrollbar space-y-1">
                        <!-- JS填充 -->
                    </div>
                </div>

                <!-- 日志面板 -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden flex-1 min-h-[500px] flex flex-col">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                        <h2 class="text-sm font-bold text-slate-700"><i class="fas fa-list-ul mr-2 text-slate-400"></i>系统运行日志</h2>
                        <button onclick="clearLogs()" class="text-xs text-slate-400 hover:text-rose-500"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 custom-scrollbar space-y-3 bg-slate-50/30" id="log-container">
                        <!-- 日志内容 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === 通用工具 ===
        function showToast(msg, type='info') {
            const div = document.createElement('div');
            div.className = `p-4 rounded-xl shadow-lg bg-white border flex items-center gap-3 transform transition-all duration-300 pointer-events-auto`;
            if(type === 'success') div.classList.add('border-emerald-200', 'text-emerald-700');
            else div.classList.add('border-rose-200', 'text-rose-700');
            div.innerHTML = `<span class="text-xs font-bold">${msg}</span>`;
            document.getElementById('toast-container').appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // === 核心逻辑 ===
        let currentPlaylistName = null;

        // 1. 媒体控制
        async function controlMedia(action) {
            try {
                const res = await fetch(`/api/control/${action}`, { method: 'POST' });
                const data = await res.json();
                if(!data.success) showToast(data.msg, 'error');
            } catch(e) { showToast("连接失败", 'error'); }
        }

        // 2. 手动搜索/播放
        async function manualPlay() {
            const val = document.getElementById('song-input').value.trim();
            if(!val) return showToast("请输入内容", 'error');
            
            const btn = document.getElementById('play-btn');
            btn.disabled = true;
            
            try {
                const res = await fetch('/api/manual_exec', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ song_name: val })
                });
                const data = await res.json();
                if(data.success) {
                    showToast(data.msg, 'success');
                    updateLogs();
                    document.getElementById('song-input').value = '';
                } else {
                    showToast(data.msg, 'error');
                }
            } catch(e) { showToast("请求异常", 'error'); }
            finally { btn.disabled = false; }
        }

        // 3. 获取歌单列表
        async function loadPlaylists() {
            try {
                const res = await fetch('/api/playlists');
                const list = await res.json();
                const container = document.getElementById('playlist-list');
                
                if(list.length === 0) {
                    container.innerHTML = '<div class="text-xs text-slate-400 text-center py-4">暂无歌单</div>';
                    return;
                }

                container.innerHTML = list.map(pl => `
                    <div onclick="openPlaylist('${pl.name}')" class="group flex justify-between items-center p-3 rounded-lg bg-slate-50 hover:bg-white border border-transparent hover:border-indigo-100 hover:shadow-sm cursor-pointer transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded bg-indigo-100 text-indigo-500 flex items-center justify-center text-xs font-bold">${pl.name[0]}</div>
                            <div>
                                <p class="text-xs font-bold text-slate-700">${pl.name}</p>
                                <p class="text-[10px] text-slate-400">${pl.count} 首歌曲</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-slate-300 text-xs group-hover:text-indigo-400"></i>
                    </div>
                `).join('');
            } catch(e) {}
        }

        // 4. 打开歌单详情
        async function openPlaylist(name) {
            currentPlaylistName = name;
            document.getElementById('playlist-detail-panel').classList.remove('hidden');
            document.getElementById('current-playlist-title').innerText = name;
            document.getElementById('trigger-word').innerText = name;
            
            // 加载歌曲
            const res = await fetch(`/api/playlists/${name}/songs`);
            const songs = await res.json();
            renderSongs(songs);
        }

        function renderSongs(songs) {
            const container = document.getElementById('playlist-songs-list');
            if(songs.length === 0) {
                container.innerHTML = '<div class="text-xs text-slate-400 py-4 text-center">暂无歌曲，请添加</div>';
                return;
            }
            container.innerHTML = songs.map((song, idx) => `
                <div class="flex justify-between items-center p-2 hover:bg-slate-50 rounded text-xs border-b border-slate-50 last:border-0">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <span class="text-slate-300 w-4">${idx+1}</span>
                        <span class="font-bold text-slate-700 truncate">${song.name}</span>
                    </div>
                    <button onclick="deleteSong(${song.id})" class="text-slate-300 hover:text-rose-500 px-2"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        function closePlaylistDetail() {
            document.getElementById('playlist-detail-panel').classList.add('hidden');
            currentPlaylistName = null;
        }

        // 5. 创建歌单
        async function createPlaylistPrompt() {
            const name = prompt("请输入新歌单名称：");
            if(!name) return;
            const res = await fetch('/api/playlists', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name })
            });
            const data = await res.json();
            if(data.success) { loadPlaylists(); showToast("创建成功", 'success'); }
            else showToast(data.msg, 'error');
        }

        // 6. 添加歌曲
        async function addSongToPlaylist() {
            if(!currentPlaylistName) return;
            const nameInput = document.getElementById('new-song-name');
            const urlInput = document.getElementById('new-song-url');
            
            if(!nameInput.value || !urlInput.value) return showToast("请填写完整", 'error');
            
            const res = await fetch(`/api/playlists/${currentPlaylistName}/songs`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name: nameInput.value, url: urlInput.value })
            });
            const data = await res.json();
            if(data.success) {
                nameInput.value = ''; urlInput.value = '';
                openPlaylist(currentPlaylistName); // 刷新
                loadPlaylists(); // 刷新计数
                showToast("添加成功", 'success');
            } else {
                showToast(data.msg, 'error');
            }
        }

        // 7. 删除歌曲
        async function deleteSong(id) {
            if(!confirm("确定移除这首歌吗？")) return;
            const res = await fetch(`/api/songs/${id}`, { method: 'DELETE' });
            if(await res.json().then(d=>d.success)) {
                openPlaylist(currentPlaylistName);
                loadPlaylists();
            }
        }
        
        // 8. 删除当前歌单
        async function deleteCurrentPlaylist() {
            if(!confirm(`确定删除歌单 "${currentPlaylistName}" 吗？所有歌曲也会被删除。`)) return;
            const res = await fetch(`/api/playlists/${currentPlaylistName}`, { method: 'DELETE' });
            if(await res.json().then(d=>d.success)) {
                closePlaylistDetail();
                loadPlaylists();
                showToast("歌单已删除", 'success');
            }
        }
        
        // 9. 重命名歌单
        async function renameCurrentPlaylist() {
            const newName = prompt("重命名为：", currentPlaylistName);
            if(!newName || newName === currentPlaylistName) return;
            
            const res = await fetch(`/api/playlists/${currentPlaylistName}/rename`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ new_name: newName })
            });
            
            if(await res.json().then(d=>d.success)) {
                closePlaylistDetail();
                loadPlaylists();
                openPlaylist(newName);
            }
        }

        // 10. 更新日志与状态
        async function updateLogs() {
            const res = await fetch('/api/logs');
            const logs = await res.json();
            const html = logs.map(log => {
                // 将链接转为重播按钮 (略，保持原有逻辑)
                return `<div class="p-3 bg-white border-b border-slate-100 last:border-0">
                    <div class="flex justify-between mb-1">
                        <span class="text-[10px] bg-slate-100 px-1.5 rounded text-slate-500">${log.type}</span>
                        <span class="text-[10px] text-slate-300 font-mono">${log.time}</span>
                    </div>
                    <div class="text-xs font-bold text-slate-700 break-all">${log.detail}</div>
                    <div class="text-[10px] text-slate-400 mt-1">${log.status}</div>
                </div>`;
            }).join('');
            document.getElementById('log-container').innerHTML = html || '<p class="text-center text-xs text-slate-300 mt-10">暂无日志</p>';
        }
        
        async function updateStats() {
            const res = await fetch('/api/stats');
            const data = await res.json();
            document.getElementById('last-heartbeat').innerText = data.last_heartbeat;
            document.getElementById('success-count').innerText = data.success_count;
            
            const modeDisplay = document.getElementById('play-mode-display');
            if(data.playlist_mode) {
                modeDisplay.innerText = `正在播放歌单: ${data.current_playlist}`;
                modeDisplay.className = "text-sm font-bold text-indigo-600 break-words";
            } else {
                modeDisplay.innerText = "单曲/待机模式";
                modeDisplay.className = "text-lg font-black text-slate-700";
            }
        }
        
        async function clearLogs() {
            if(confirm("清空日志？")) {
                await fetch('/api/clear_logs', { method: 'POST' });
                updateLogs();
            }
        }

        // 初始化
        loadPlaylists();
        updateLogs();
        updateStats();
        setInterval(() => { updateLogs(); updateStats(); }, 3000);

    </script>
</body>
</html>